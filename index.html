<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Annotator</title>
    <link rel="stylesheet" href="index.css">
    <script src="https://code.jquery.com/jquery-3.6.3.js" integrity="sha256-nQLuAZGRRcILA+6dMBOvcRh5Pe310sBpanc6+QBmyVM=" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
</head>
<body>
    <h1>Video Annotator</h1>
    <div class="container">
        <div class="row">
            <div class="col-sm-8 text-center">
                <label for="input">Choose a video file to annotate:</label>
                <input type="file" id="input" name="input_video" accept="video/*">
                <video id="video" controls style="display: none;" width="650px" height="375px">
                    <source src="stars-6962.mp4" type="video/mp4">
                </video>
            </div>
            <div class="col-sm-4">
                <button class ="pause"> Annotate </button>
                <button class ="play"> Continue playing </button>
                <textarea id="freeform" name="freeform" rows="15" cols="50"></textarea>
                <button onclick="display()">Add note</button>
                <button onclick="save()">Save</button>
            </div>
            <br>
            <div class="col-sm-4" id="notes">
                <div id ='notes'>
                    <h3>Notes:</h3>
                </div>
                
            </div>
        </div>
    </div>
</body>
<script src="index.js"></script>
<script>
    function display() {
        var new_p_tag = `<p></p>`
        document.querySelector("#notes").insertAdjacentHTML('beforeend', new_p_tag)
        var notetxt = document.getElementById("freeform").value;
        var p_tags = document.getElementsByTagName('p')
        var p_tag = p_tags[p_tags.length-1]
        p_tag.textContent += notetxt
        document.getElementById("freeform").value = ''
    }

    // https://stackoverflow.com/questions/68247381/how-to-download-an-array-in-txt-on-javascript    
    function download(filename, text) {
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);

        element.style.display = 'none';
        document.body.appendChild(element);

        element.click();

        document.body.removeChild(element);
    }

    function save() {
        var lines = new Array();
        p_tags = $('p');
        p_tags.each(function(index){
            if ($( this ).text().startsWith("Timestamp:")){
                var line = `timestamp, note\n${$( this ).text()}`;
                line += ","
                p_tags.slice(index+1).each(function(index2){
                    if (!$(this).text().startsWith("Timestamp:")){
                        line += ` * ${$(this).text()}`;
                    } else { return false; }
                })
                line += "\n"
                lines.push(line)
            }
        })
        console.log(lines)
        download("output.csv", lines.join(''))
    }
</script>
</html>
